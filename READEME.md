---
title: ä¸€ç å½’ä¸€ç 
date: 2023-11-21 18:12:32
tags: [iOS]
---

---

## Barcode

&#8195;&#8195;"Barcode"ï¼ˆæ¡å½¢ç ï¼‰æ˜¯ä¸€ç§ç”¨äºå‚¨å­˜å’Œæ£€ç´¢æ•°æ®çš„å›¾å½¢æ ‡è¯†ç¬¦ã€‚å®ƒé€šå¸¸ç”±ä¸€ç³»åˆ—å®½åº¦å’Œé—´éš™ä¸åŒçš„æ¡å’Œç©ºç»„æˆï¼Œç”¨äºè¡¨ç¤ºæ•°å­—ã€å­—æ¯å’Œå…¶ä»–å­—ç¬¦ã€‚æ¡å½¢ç åœ¨å•†ä¸šã€ç‰©æµã€åº“å­˜ç®¡ç†å’Œå…¶ä»–é¢†åŸŸå¹¿æ³›åº”ç”¨ï¼Œä»¥æé«˜æ•°æ®çš„è¿½è¸ªå’Œç®¡ç†æ•ˆç‡ã€‚

æ¡å½¢ç çš„ä¸»è¦ç±»å‹åŒ…æ‹¬ä¸€ç»´ç ï¼ˆ1D Barcodeï¼‰å’ŒäºŒç»´ç ï¼ˆ2D Barcodeï¼‰ã€‚

1. **ä¸€ç»´ç ï¼ˆ1D Barcodeï¼‰ï¼š** ä¸€ç»´ç æ˜¯ç”±ä¸€ç³»åˆ—å®½åº¦å’Œé—´éš™ä¸åŒçš„æ¡å’Œç©ºç»„æˆçš„å›¾å½¢ï¼Œç”¨äºè¡¨ç¤ºçº¿æ€§çš„æ•°æ®ã€‚ä¸€ç»´ç ä¸»è¦ç”¨äºè¡¨ç¤ºæ•°å­—ã€å­—æ¯å’Œå…¶ä»–ç‰¹å®šå­—ç¬¦ã€‚å¸¸è§çš„ä¸€ç»´ç ç±»å‹åŒ…æ‹¬Code 39ã€Code 128ã€UPCã€EANç­‰ã€‚
2. **äºŒç»´ç ï¼ˆ2D Barcodeï¼‰ï¼š** äºŒç»´ç æ˜¯ç”±ä¸€ç³»åˆ—é»‘ç™½å—ç»„æˆçš„å›¾å½¢ï¼Œå¯ä»¥åœ¨æ°´å¹³å’Œå‚ç›´æ–¹å‘ä¸Šè¡¨ç¤ºæ•°æ®ã€‚ç›¸æ¯”ä¸€ç»´ç ï¼ŒäºŒç»´ç å¯ä»¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€é“¾æ¥ã€å›¾åƒç­‰ã€‚å¸¸è§çš„äºŒç»´ç ç±»å‹åŒ…æ‹¬QR Codeã€Data Matrixã€Aztec Codeç­‰ã€‚

&#8195;&#8195;ç”Ÿæ´»ä¸­æˆ‘ä»¬æåˆ°â€œæ¡å½¢ç â€ï¼Œå…¶å®å¤šæ•°åœºæ™¯æŒ‡çš„æ˜¯ä¸€ç»´çš„ã€‚ä¹‹å‰æ¥å…¥çš„å‚å•†é—®æˆ‘æœ€å¸¸ç”¨çš„æ¡å½¢ç æ˜¯å“ªç§ï¼Œç¡®å®é—®ç€æˆ‘äº†ï¼Œå“ˆå“ˆå“ˆã€‚

&#8195;&#8195;æ¡å½¢ç æ˜¯ä¸€ç§ç”¨äºå‚¨å­˜å’Œè·å–ä¿¡æ¯çš„ç¼–ç æ–¹å¼ï¼Œä¸åŒçš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚å¯¼è‡´äº†å¤šç§ç±»å‹çš„æ¡å½¢ç çš„äº§ç”Ÿã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ¡å½¢ç ç±»å‹ï¼š

1. **UPC (Universal Product Code):** é€šç”¨äº§å“ä»£ç ï¼Œä¸»è¦ç”¨äºé›¶å”®ä¸šï¼Œå°¤å…¶æ˜¯åœ¨åŒ—ç¾åœ°åŒºã€‚UPC é€šå¸¸ç”¨äºæ ‡è¯†å•†å“ã€‚
2. **EAN (International Article Number):** å›½é™…å•†å“ç¼–ç ï¼Œä¸UPCç±»ä¼¼ï¼Œä¹Ÿç”¨äºå•†å“æ ‡è¯†ã€‚EAN é€šå¸¸æ˜¯ 13 ä½çš„æ•°å­—ç ï¼Œå½“ç„¶ä¹Ÿæœ‰ 8 ä½çš„ã€‚
3. **Code 39:** ä¸€ç§å¸¸è§çš„çº¿æ€§æ¡å½¢ç ï¼Œæ”¯æŒå­—æ¯ã€æ•°å­—å’Œä¸€äº›ç‰¹æ®Šå­—ç¬¦ã€‚å¸¸ç”¨äºå·¥ä¸šã€ç‰©æµå’Œæ ‡ç­¾æ‰“å°ã€‚
4. **Code 128:** å¦ä¸€ç§å¸¸è§çš„çº¿æ€§æ¡å½¢ç ï¼Œå…·æœ‰æ›´é«˜çš„æ•°æ®å¯†åº¦å’Œå­—ç¬¦é›†æ”¯æŒã€‚å¹¿æ³›ç”¨äºç‰©æµå’Œåˆ¶é€ ä¸šã€‚
5. **QR Code (Quick Response Code):** äºŒç»´ç ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€é“¾æ¥ã€å›¾åƒç­‰ã€‚å¸¸è§äºå¹¿å‘Šã€ç§»åŠ¨æ”¯ä»˜ã€ç¥¨åŠ¡ç­‰é¢†åŸŸã€‚
6. **Aztec Codeï¼š**å¦ä¸€ç§äºŒç»´ç ï¼Œé˜¿å…¹ç‰¹å…‹ç ï¼Œå¸¸ç”¨äºéœ€è¦é«˜å¯†åº¦æ•°æ®å­˜å‚¨çš„åœºæ™¯ï¼Œä¾‹å¦‚ç¥¨åŠ¡ã€èº«ä»½è¯ã€æ”¯ä»˜ç³»ç»Ÿç­‰ã€‚
7. **Data Matrix:** å¦ä¸€ç§äºŒç»´ç ï¼Œå¯ä»¥å­˜å‚¨å¤§é‡æ•°æ®ï¼Œç‰¹åˆ«é€‚ç”¨äºå°ç©ºé—´ã€‚å¸¸ç”¨äºç”µå­å…ƒä»¶ã€åˆ¶é€ ä¸šå’ŒåŒ»ç–—è®¾å¤‡ã€‚
8. **PDF417:** ä¸€ç§å †å å¼çš„äºŒç»´ç ï¼Œå¯ä»¥å­˜å‚¨å¤§é‡ä¿¡æ¯ã€‚é€šå¸¸ç”¨äºèº«ä»½è¯ã€é©¾é©¶è¯ç­‰è¯ä»¶ã€‚

&#8195;&#8195;è¿™åªæ˜¯ä¸€å°éƒ¨åˆ†å¸¸è§çš„æ¡å½¢ç ç±»å‹ï¼Œå®é™…ä¸Šè¿˜æœ‰è®¸å¤šå…¶ä»–ç±»å‹ï¼Œæ¯ç§éƒ½æœ‰å…¶ç‰¹å®šçš„ç”¨é€”å’Œåº”ç”¨é¢†åŸŸã€‚é€‰æ‹©æ¡å½¢ç ç±»å‹é€šå¸¸å–å†³äºéœ€è¦å­˜å‚¨çš„ä¿¡æ¯é‡ã€å¯è¯»æ€§è¦æ±‚ä»¥åŠåº”ç”¨çš„å…·ä½“è¦æ±‚ã€‚

## QR Scanner

&#8195;&#8195;å¾€å¸¸æ‰«ç çš„éœ€æ±‚ä¸å¤šï¼Œå¤šæ•°åœºæ™¯ä»…éœ€è¦æ‰«æäºŒç»´ç ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡ `AVFoundation` æ¥æ‰«æå¹¶è¯†åˆ«æ¡ç ï¼Œ`AVMetadataObject.ObjectType` æ”¯æŒçš„æ¡ç ç±»å‹åŒ…å«äº†å¤§éƒ¨åˆ†å¸¸è§çš„ç±»å‹:

```swift
AVMetadataObjectTypeUPCECode
AVMetadataObjectTypeCode39Code
AVMetadataObjectTypeCode39Mod43Code
AVMetadataObjectTypeEAN13Code
AVMetadataObjectTypeEAN8Code
AVMetadataObjectTypeCode93Code
AVMetadataObjectTypeCode128Code
AVMetadataObjectTypePDF417Code
AVMetadataObjectTypeQRCode
AVMetadataObjectTypeAztecCode
AVMetadataObjectTypeInterleaved2of5Code
AVMetadataObjectTypeITF14Code
AVMetadataObjectTypeDataMatrixCode
```

&#8195;&#8195;å¯¹äºè¯†åˆ«å›¾ç‰‡ä¸­çš„æ¡å½¢ç ï¼Œè¿™ä¸ªåº“ä½¿ç”¨çš„æ˜¯
```swift
CIDetector(ofType: CIDetectorTypeQRCode, context: context)
```

ï¼Œå…³äºæ¡å½¢ç æ”¯æŒçš„ç±»å‹ä¹Ÿå¾ˆç›´ç™½ - CIDetectorTypeQRCodeï¼Œåªæ”¯æŒäºŒç»´ç ...æ‰€ä»¥æƒ³ä»ç…§ç‰‡ä¸­è¯†åˆ«ä¸€ç»´ç ï¼Œè¦æ¢ä¸ªæ€è·¯äº†ã€‚

## Vision

&#8195;&#8195;è‹¹æœä» ios11.0 å¼€å§‹æ”¯æŒ FaceIDï¼Œç›¸åº”æ¨å‡ºäº† Vision æ¡†æ¶ã€‚Vision æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå’Œè§†è§‰å¤„ç†çš„æ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„å·¥å…·å’ŒåŠŸèƒ½ï¼Œæ¶µç›–äº†å¤šä¸ªé¢†åŸŸï¼ŒåŒ…æ‹¬é¢éƒ¨è¯†åˆ«ã€æ–‡æœ¬è¯†åˆ«ã€ç‰©ä½“è¿½è¸ªç­‰ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº› Vision æ¡†æ¶çš„ä¸»è¦åŠŸèƒ½ï¼š

1. **é¢éƒ¨è¯†åˆ«ï¼ˆFace Recognitionï¼‰ï¼š** Vision æ¡†æ¶å¯ä»¥æ£€æµ‹å›¾åƒä¸­çš„é¢éƒ¨ï¼Œè¯†åˆ«é¢éƒ¨çš„ç‰¹å¾ï¼Œä¾‹å¦‚çœ¼ç›ã€å˜´å·´ã€é¼»å­ç­‰ã€‚å®ƒè¿˜èƒ½å¤Ÿè¿›è¡Œé¢éƒ¨è¿½è¸ªï¼Œè·Ÿè¸ªåœ¨è§†é¢‘ä¸­ç§»åŠ¨çš„é¢éƒ¨ã€‚
2. **æ–‡æœ¬è¯†åˆ«ï¼ˆText Recognitionï¼‰ï¼š** Vision æ¡†æ¶æ”¯æŒå¯¹å›¾åƒä¸­çš„æ–‡æœ¬è¿›è¡Œè¯†åˆ«ã€‚è¿™å¯¹äºä»ç…§ç‰‡æˆ–æ‘„åƒå¤´ä¸­æ•æ‰åˆ°çš„æ–‡æœ¬è¿›è¡Œå®æ—¶å¤„ç†å¾ˆæœ‰ç”¨ã€‚
3. **ç‰©ä½“è¿½è¸ªï¼ˆObject Trackingï¼‰ï¼š** Vision æ¡†æ¶å¯ä»¥è¿½è¸ªå›¾åƒæˆ–è§†é¢‘ä¸­çš„ç‰©ä½“ï¼Œä½¿å¾—ä½ èƒ½å¤Ÿè·Ÿè¸ªç‰©ä½“çš„ä½ç½®éšæ—¶é—´çš„å˜åŒ–ã€‚
4. **å›¾åƒåˆ†ç±»å’Œè¯†åˆ«ï¼ˆImage Classificationï¼‰ï¼š** Vision æ¡†æ¶æ”¯æŒé€šè¿‡æœºå™¨å­¦ä¹ æ¨¡å‹å¯¹å›¾åƒè¿›è¡Œåˆ†ç±»å’Œè¯†åˆ«ã€‚ä½ å¯ä»¥ä½¿ç”¨é¢„è®­ç»ƒçš„æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥é›†æˆè‡ªå·±è®­ç»ƒçš„æ¨¡å‹ã€‚
5. **å›¾åƒåˆ†å‰²ï¼ˆImage Segmentationï¼‰ï¼š** Vision æ¡†æ¶å…è®¸å¯¹å›¾åƒè¿›è¡Œåˆ†å‰²ï¼Œå°†å›¾åƒä¸­çš„ä¸åŒåŒºåŸŸæ ‡è®°ä¸ºä¸åŒçš„å¯¹è±¡ã€‚

è®²çœŸï¼Œä¹‹å‰åœ¨å·¥ä½œä¸­ä¸€ä¸ªä¹Ÿæ²¡ç”¨ä¸Š...æ‰€ä»¥ä¸å†æ•¢ç§°è‡ªå·±ä¸ºå¼€å‘è€…äº†ï¼ŒiOSer ç§’å˜ Ioserï¼Œæ‡‚å¾—éƒ½æ‡‚ã€‚ğŸ¤§

è¨€å½’æ­£ä¼ ï¼š

&#8195;&#8195;ç¿»ä¸€ç¿»æ¡†æ¶åŒ…å« detect å­—æ ·çš„ APIï¼Œå¾ˆå¤š â€œVision/VNDetect--â€ï¼Œæœ‰ä¸€ä¸ª **VNDetectBarcodesRequest** çœ‹ä¸Šå»éå¸¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚å‘é€å›¾åƒè¯†åˆ«è¯·æ±‚ï¼Œéœ€è¦é€šè¿‡ **VNImageRequestHandler**ï¼Œè¿™ä¸ªç±»å‹ç”¨äºå¤„ç†å•ä¸ªå›¾åƒä¸Šçš„ Vision è¯·æ±‚ã€‚

### VNImageRequestHandler

&#8195;&#8195;å°è¯•äº†å‡ ä¸ª APIã€åœ¨ OC ä¸­ä¸å°å¿ƒé€ äº†ä¸ªåƒµå°¸ã€æŠ“åƒµå°¸æŠ“äº†åŠå¤©ğŸ˜ˆï¼Œæœ€ç»ˆé€‰æ‹©ç”¨ CVPixelBuffer æ¥åˆ›å»ºè¯·æ±‚ï¼Œå…¶ä»–ä½¿ç”¨ CGImage çš„æ–¹å¼å ç”¨çš„å†…å­˜ä¼¼ä¹æ¯”è¾ƒé«˜ï¼Ÿï¼Œå› ä¸ºæˆ‘æ‹¿ä¸€å¼ å•åç›¸æœºæ‹çš„ç•¥å¤§è‰ºæœ¯ç…§åšæµ‹è¯•ï¼ŒæŒ‚æ‰äº†...

```swift
func detectBarcodeFromImg(_ oriImg: UIImage, _ completion: @escaping (Barcode) -> Void) {
		...
    DispatchQueue.init(label: "com.yydetector.session.queue").async { [self] in                                                                     
        guard let buffer = pixelBuffer(from: oriImg!) else {
            print("Image type not support!")
            return
        }
                                                                     
        let requestHandler = VNImageRequestHandler.init(cvPixelBuffer: buffer)
        do {
            let detectRequest = VNDetectBarcodesRequest { [self] request, error in
                if let error = error {
                    print(error.localizedDescription)
                    return
                }

                if request.results!.isEmpty {
                    print("No result of request!")
                    return
                }

                for case let barcode as VNBarcodeObservation in request.results! {
                    if barcode.payloadStringValue != nil {
                        let formatter = printBarcode(barcode)
                        print(formatter)
                    } else {
                        print("No payload string value!")
                    }
                }
            }

            try requestHandler.perform([detectRequest])
        } catch {
          	print(error.localizedDescription)
        }
    }
}
```

&#8195;&#8195;è¯†åˆ«åˆ°çš„ç»“æœä¼šé€šè¿‡ VNBarcodeObservation ç±»å‹æ¥è¿”å›ï¼Œé‡Œé¢çš„å±æ€§éå¸¸è¯¦ç»†ï¼Œæ‰“å°äº†å‡ ä¸ªï¼Œå…¶ä»–çš„ä¸åœ¨è¿™é‡Œç½—åˆ—äº†ï¼š

```swift
âœ… VNBarcodeObservation:
 ã€½ï¸value = http://weixin.qq.com/r/cHVyahfEvErDrVMJ9yBi, 
 ã€½ï¸type = VNBarcodeSymbologyQR, 
 ã€½ï¸confidence = 1.0, 
 ã€½ï¸boundingBox = 
	 x = 0.267, 
	 y = 0.407, 
	 w = 0.130, 
	 h = 0.060, 
 ã€½ï¸desc : 
	 symbolVersion = 3, 
	 maskPattern = 2, 
	 errorCorrectionLevel = 76, 
	 errorCorrectedPayload =  
```

payloadStringValue(value) - æ¡ç å†…å®¹ï¼›
symbology(type) - æ¡ç ç±»å‹ï¼›
confidence - è¡¨æ˜äº†è¯†åˆ«è¿™ä¸ªç çš„ä¿¡å¿ƒï¼Œ0.6~1 è²Œä¼¼æ¯”è¾ƒå¤šï¼Œå¤ªä½çš„è¯æ¡†æ¶ä¹Ÿå°±ä¸è¯†åˆ«äº†ã€æˆ–è€…ä¸å»ºè®®ä½¿ç”¨ï¼›
boundingBox - æ˜¯æ¡å½¢ç çš„è¯†åˆ«åŒºåŸŸï¼›
errorCorrectionLevel - çº é”™çº§åˆ«ï¼›

### æ¡å½¢ç çš„èƒŒæ™¯è‰²

&#8195;&#8195;åŸæœ¬ä»¥ä¸ºå†™åˆ°è¿™é‡Œä½œä¸ºä¸€ä¸ªè¡¥å……åŠŸèƒ½ä¹Ÿç®—æ˜¯å¤Ÿç”¨äº†ï¼Œç›´åˆ°æµ‹è¯•æ‹¿å‡ºäº†ä¸‹é¢è¿™å¼ å›¾ï¼šç”¨åœ¨çº¿å·¥å…·éšä¾¿ç”Ÿæˆäº†ä¸€ä¸ªæ¡å½¢ç ã€ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œã€è¯†åˆ«ï¼Œæ‰«ç å¯ä»¥æ‰«å‡ºæ¥ï¼Œä½†è¯†åˆ«ä¸å‡ºæ¥[Emm][Emm]...

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_4.jpg 300%}</div>
</center>

&#8195;&#8195;ç çœ‹ç€æ˜¯ä¸ªæ­£ç»ç ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¯†åˆ«ä¸å‡ºæ¥å‘¢ï¼Ÿå·¦å³ä¸¤ä¾§çš„è¾¹ç¼˜å¤„è´´è¾¹äº†ï¼ŸPC ä¸Šæˆªå›¾å†ä¿å­˜ï¼Œä¹Ÿæ˜¯å¯ä»¥è¯†åˆ«å‡ºæ¥çš„ï¼Œé‚£ä¼°è®¡å°±æ˜¯è´´è¾¹å¯¼è‡´çš„...è¯´åˆ°è¿™é‡Œï¼Œä½ å¯ä»¥éšæ‰‹æ‹¿èµ·ä¸€ä¸ªèº«è¾¹æœ‰æ¡ç çš„ç‰©å“ï¼Œä¸è®ºç‰©å“çš„å¤–åŒ…è£…æ˜¯ä»€ä¹ˆé¢œè‰²çš„ï¼Œæ¡ç ä¸€èˆ¬éƒ½ä¼šå•ç‹¬æœ‰ä¸€ä¸ªç™½è‰²ï¼ˆæµ…è‰²ï¼‰çš„ã€ç çš„å››å‘¨æœ‰ç©ºç™½çš„èƒŒæ™¯åŒºåŸŸï¼Œç›®çš„å°±æ˜¯ä¸ºäº†æ‰«ç çš„æ—¶å€™å¯ä»¥è¯†åˆ«çš„å¿«ä¸€ç‚¹ã€‚çœ‹åˆ°æœ‰ä¸ªå¤–å›½ç½‘å‹æé—®ï¼šâ€œè‡ªå·±åœ¨å¸®ä¸€ä¸ªå½©è‰²æ°´ç¬”çš„å…¬å¸åšæ‰«ç åŠŸèƒ½ï¼Œä»–ä»¬æ°´ç¬”çš„å¤–åŒ…è£…æ˜¯åæš—é»‘è‰²çš„ã€æ°´ç¬”çš„æ¡å½¢ç æ˜¯...äº”é¢œå…­è‰²çš„å½©è‰²ï¼Œç»“è´¦æ‰«ç æ—¶æ€»æ˜¯å¾ˆæ…¢ï¼Œå¦‚ä½•æåˆ°æ‰«ç çš„æ•ˆç‡ï¼Ÿâ€å’±å°±æ˜¯è¯´ï¼Œæ¢ä¸ªå¤–åŒ…è£…å‘¢ğŸ˜¶...

&#8195;&#8195;é‚£å½±å“æ‰«ç æ•ˆç‡çš„å› ç´ éƒ½æœ‰å“ªäº›ï¼Œé™¤äº†ç çš„å½¢çŠ¶(å¤æ‚åº¦)ï¼Œæ˜¯ä¸æ˜¯è¿˜æœ‰èƒŒæ™¯è‰²æˆ–è€…è¯´å¯¹æ¯”åº¦ï¼Ÿæœ¬æ¥æƒ³å°è¯•ä¸€ä¸‹â€œæŠ å›¾â€ï¼ŒæŠŠè¿™ä¸ªè´´è¾¹çš„æ¡å½¢ç æ‰£åˆ°ä¸€ä¸ªç™½è‰²èƒŒæ™¯ä¸Šï¼Œç»“æœç®—æ³•æ²¡æ•´æ˜ç™½ï¼ŒæŠ å‡ºæ¥ä¸€ä¸ªè«åå…¶å¦™çš„æ•ˆæœï¼š

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_6.PNG 200%}</div>
	<div style="display:inline-block;margin-left:10px;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_7.PNG 200%}</div>
</center>

so...æ”¾å¼ƒã€‚æŠ å®ƒå¹²å˜›å‘¢ï¼Œç›´æ¥ç”»åˆ°ä¸€ä¸ªç™½è‰²çš„èƒŒæ™¯å›¾ç‰‡ä¸Šå‘¢ï¼Ÿä¸ºäº†é¿å…å†å‡ºç°è¿™ç§è´´è¾¹çš„å›¾ã€é•‚ç©ºçš„å›¾ï¼Œå…ˆæ˜¯ç”»äº†ä¸€ä¸ªæ¯”åŸå›¾çš„å®½é«˜éƒ½å¤§ 10 çš„ç™½è‰²å›¾ç‰‡ï¼Œç„¶åæŠŠåŸå›¾æ”¾åˆ°ç™½è‰²èƒŒæ™¯æ¿çš„ä¸­å¿ƒï¼Œå†è¯†åˆ«ï¼Œå°±æˆåŠŸäº†ã€‚

```swift
func imageFromColor(_ color: UIColor, size: CGSize) -> UIImage! {
    let rect = CGRect(x: 0, y: 0, width: size.width + 10, height: size.height + 10)

    UIGraphicsBeginImageContext(rect.size)
    guard let context = UIGraphicsGetCurrentContext() else {
        return UIImage(named: "scan_bg")
    }

    context.setFillColor(color.cgColor)
    context.fill(rect)

    let image = UIGraphicsGetImageFromCurrentImageContext()
    UIGraphicsEndImageContext()

    return image
}

func drawImage(_ oriImg: CGImage, toCenter bgImg: CGImage) -> UIImage? {
    let targetSize = CGSize(width: CGFloat(bgImg.width), height: CGFloat(bgImg.height))

    UIGraphicsBeginImageContextWithOptions(targetSize, false, 0.0)

    let bottomImage = UIImage(cgImage: bgImg)
    bottomImage.draw(in: CGRect(x: 0, y: 0, width: targetSize.width, height: targetSize.height))

    let scaledSize = CGSize(width: CGFloat(oriImg.width), height: CGFloat(oriImg.height))
    let destinationRect = CGRect(
        x: (targetSize.width - scaledSize.width) / 2,
        y: (targetSize.height - scaledSize.height) / 2,
        width: scaledSize.width,
        height: scaledSize.height
    )

    let centeredImage = UIImage(cgImage: oriImg)
    centeredImage.draw(in: destinationRect)

    let finalImage = UIGraphicsGetImageFromCurrentImageContext()
    UIGraphicsEndImageContext()

    return finalImage
}
```

```swift
âœ… VNBarcodeObservation:
 ã€½ï¸value = 304329G00015157, 
 ã€½ï¸type = VNBarcodeSymbologyCode128, 
 ã€½ï¸confidence = 0.8, 
 ã€½ï¸boundingBox = 
	 x = 0.015, 
	 y = 0.116, 
	 w = 0.970, 
	 h = 0.024, 
 ã€½ï¸desc :  
```

### å¾‹åŠ¨çš„å°ç®­å¤´

&#8195;&#8195;å½“çœ‹åˆ° Vision è¿”å›äº† boundingBox æ—¶ï¼Œåˆæƒ³åˆ°äº†ä¸€ä¸ªéœ€æ±‚ï¼šå¦‚æœå›¾ç‰‡ä¸Šæœ‰å¤šä¸ªæ¡ç æ—¶ï¼Œåœ¨æ¯ä¸ªå¯è¯†åˆ«çš„åŒºåŸŸåŠ ä¸€ä¸ªå°ç®­å¤´ğŸ”œï¼Œè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©ä½¿ç”¨å“ªä¸ªç»“æœã€‚æ•ˆæœå¦‚ä¸‹ï¼š

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_1.jpg 200%}</div>
	<div style="display:inline-block;margin-left:10px;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_2.jpg 200%}</div>
  <div style="display:inline-block;margin-left:10px;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_3.jpg 200%}</div>
</center>
æ€è·¯æ˜¯ï¼š

1. è¯†åˆ«åˆ°æ¯ä¸ªæ¡ç çš„ **boundingBox**ï¼Œæ³¨æ„åæ ‡ç³»æ˜¯ (0,1) åæ ‡ï¼Œå…ˆç®€ç§°ä¸º CI åæ ‡ç³»å§ï¼›
2. å›¾ç‰‡åœ¨ ImageView ä¸Šçš„é¢„è§ˆæ¨¡å¼æ˜¯ UIView.ContentMode = **scaleAspectFit**ï¼Œæƒ³å‡†ç¡®æ”¾ç½®å°ç®­å¤´ï¼Œé‚£éœ€è¦å…ˆæ‹¿åˆ°å›¾ç‰‡åŸºäº ImageView çš„åŒºåŸŸï¼Œè¿™é‡Œç§°ä¸º UI åæ ‡ç³»ï¼šï¼ˆæ­¤ç‰‡æ®µæ¥è‡ª ChatGPTï¼Œå“ˆå“ˆã€‚è®²çœŸï¼Œä»£ç è§„èŒƒæ¯”æˆ‘ä»¬æŸäº›åŒå¿—çš„ä»£ç éƒ½å¹²å‡€ï¼‰

```swift
extension UIImageView {
    func renderingRectForImage() -> CGRect? {
      ...
            
        case .scaleAspectFit:
            let scale = min(imageViewBounds.width / imageSize.width, imageViewBounds.height / imageSize.height)
            let width = imageSize.width * scale
            let height = imageSize.height * scale
            renderingRect.size = CGSize(width: width, height: height)
            renderingRect.origin.x = (imageViewBounds.width - width) / 2
            renderingRect.origin.y = (imageViewBounds.height - height) / 2
            
        case .scaleAspectFill:
            let scale = max(imageViewBounds.width / imageSize.width, imageViewBounds.height / imageSize.height)
            let width = imageSize.width * scale
            let height = imageSize.height * scale
            renderingRect.size = CGSize(width: width, height: height)
            renderingRect.origin.x = (imageViewBounds.width - width) / 2
            renderingRect.origin.y = (imageViewBounds.height - height) / 2
            
        case .center:
            renderingRect.size = imageSize
            renderingRect.origin.x = (imageViewBounds.width - imageSize.width) / 2
            renderingRect.origin.y = (imageViewBounds.height - imageSize.height) / 2
            
        // å…¶ä»– contentMode ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ‰©å±•
        
        default:
            break
        }
 	 ...
        
        return renderingRect
    }
}
```

3. å¾—åˆ°å›¾ç‰‡åŒºåŸŸä»¥åï¼ŒæŠŠåŸºäº CI åæ ‡çš„ boundingBox è½¬æ¢ä¸º UI åæ ‡ï¼Œç”¨æ¥æ·»åŠ  viewï¼š

```swift
func convertCIBoundingRectToUIRect(_ ci: CGRect) -> CGRect {
    let renderingRect = imgV.renderingRectForImage()

    let w = ci.size.width * renderingRect!.size.width
    let h = ci.size.height * renderingRect!.size.height
    let x = ci.origin.x * renderingRect!.size.width + renderingRect!.origin.x
    let y = ci.origin.y * renderingRect!.size.height + renderingRect!.origin.y

    return CGRectMake(x, y, w, h)
}
```

4. åŸºäºè½¬æ¢åçš„åæ ‡åˆ›å»ºæŠ–åŠ¨çš„ç»¿è‰²å°ç®­å¤´ï¼Œå‘Šè¯‰ç”¨æˆ·â€œç‚¹æˆ‘~ç‚¹æˆ‘~â€ã€‚åˆ°è¿™ä¸€æ­¥åŸºæœ¬ä¸Šå·²ç»è¾¾åˆ°ä¸Šå›¾çš„ç›®çš„äº†ã€‚

But...
But...
But...

&#8195;&#8195;ä¸Šé¢çš„å°ç®­å¤´å…¶å®æ˜¯ç»è¿‡ä¸€æ¬¡â€œå˜æ€â€è½¬æ¢ä¹‹åçš„æ•ˆæœã€‚ç”¨è¿‡ CI åæ ‡çš„éƒ½çŸ¥é“ï¼Œåœ¨ CoreImage ä¸­æˆ–è€…è¯´è¯»åˆ°å†…å­˜ä¸­çš„å›¾ç‰‡ï¼Œåæ ‡ç³»çš„åŸç‚¹å’Œå›¾ç‰‡æ–¹å‘æ˜¯æœ‰å…³ç³»çš„ï¼Œå¹¶ä¸æ˜¯å•çº¯å’Œ UI åæ ‡ä¸Šä¸‹åè¿‡æ¥çš„å…³ç³»ã€‚æ­£å¸¸æƒ…å†µä¸‹å›¾ç‰‡çš„æ–¹å‘æ˜¯ **CGImagePropertyOrientation.up**ï¼Œæƒ³æ¨¡æ‹Ÿå…¶ä»–æ–¹å‘å¯ä»¥æŠŠæ‰‹æœºæ¨ªç€æˆ–è€…å€’è¿‡æ¥æ‹ç…§è¯•è¯•ï¼Œè¿˜ç”¨ä¸Šé¢çš„å¤šæ¡ç å›¾ç‰‡ä¸¾ä¾‹ï¼ŒæŒ‰ç…§æˆ‘ä»¬ 1-4 æ­¥éª¤å‡ºæ¥çš„æ•ˆæœå…¶å®æ˜¯è¿™æ ·çš„;

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_8.PNG 200%}</div>
</center>

å¾ˆæ˜æ˜¾ï¼Œè¯†åˆ«åŒºåŸŸéƒ½æ˜¯æœ‰çš„ï¼Œä½†åæ ‡æ–¹å‘æ˜¯ä¸å‡†ç¡®çš„ã€‚å¯ä»¥çœ‹ä¸€ä¸‹ **CGImagePropertyOrientation** çš„æ³¨è§£ï¼Œå¯¹æ¯ä¸ªæ–¹å‘çš„åŸç‚¹ä½ç½®éƒ½åšäº†è¯´æ˜ï¼š

```swift
@frozen public enum CGImagePropertyOrientation : UInt32, @unchecked Sendable {
    
    case up = 1 // 0th row at top,    0th column on left   - default orientation
...
}
```

ä¸‹ä¸€æ­¥ï¼Œ

5. éœ€è¦æŠŠå›¾ç‰‡æ–¹å‘â€œæŒ‡å®šâ€ä¸€ä¸‹ï¼Œåæ ‡è½¬æ¢æ—¶åŠ ä¸€æ¬¡â€œå˜æ€â€è½¬æ¢ - **CGAffineTransform**ï¼š

```swift
func detectBarcodeFromImg(_ oriImg: UIImage, _ completion: @escaping (Barcode) -> Void) {
		...
    DispatchQueue.init(label: "com.yydetector.session.queue").async { [self] in                                                                     
        guard let buffer = pixelBuffer(from: oriImg!) else {
            print("Image type not support!")
            return
        }
                                                                     
        let tempOrientation = getCGImagePropertyOrientation(from: oriImg.imageOrientation)
        let requestHandler = VNImageRequestHandler.init(cvPixelBuffer: buffer, orientation: tempOrientation)
        ...
    }
}

func convertCIBoundingRectToUIRect(_ cii: CGRect) -> CGRect {
    let renderingRect = imgV.renderingRectForImage()

    let ci = cii.applying(getCGAffineTransform(from: orientation!))

    let w = ci.size.width * renderingRect!.size.width
    let h = ci.size.height * renderingRect!.size.height
    let x = ci.origin.x * renderingRect!.size.width + renderingRect!.origin.x
    let y = ci.origin.y * renderingRect!.size.height + renderingRect!.origin.y

    return CGRectMake(x, y, w, h)
}

func getCGAffineTransform(from orientation: CGImagePropertyOrientation) -> CGAffineTransform {
    switch orientation {
    case .up, .down:
        return CGAffineTransform(scaleX: 1, y: 1).translatedBy(x: 0, y: 0)
    default:
        return CGAffineTransform(scaleX: -1, y: -1).translatedBy(x: -1, y: -1)
    }
}
```

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_9.PNG 200%}</div>
</center>

åˆ°è¿™é‡Œåº”è¯¥å¯ä»¥äº†å§ï¼Ÿ

But...
But...
But...

### æˆ‘çš„å°æƒ…æ€€

&#8195;&#8195;æˆ‘ä¸ªäººå¯¹æŸäº›æœºå‹æˆ–è€…ç³»ç»Ÿæœ‰è‡ªå·±å¥‡å¥‡æ€ªæ€ªçš„æƒ…æ€€ï¼Œå¾ˆå°‘ä»¥æ—§æ¢æ–°ã€‚ä¾‹å¦‚æœ‰å° iPhone 5s æ˜¯ç¬¬ä¸€ä»£æŒ‡çº¹è¯†åˆ«çš„ HOME é”®ï¼Œè®©å®ƒçš„ç³»ç»Ÿä¸€ç›´åœç•™åœ¨äº† ios9ï¼›åˆä¾‹å¦‚æœ‰å° iPhone 12 è¾¹æ¡†æ˜¯æ–¹çš„æ‰€ä»¥å–œæ¬¢ï¼Œè®©å®ƒåœåœ¨äº† ios15.4ï¼Œä¹Ÿå› ä¸ºè«åå…¶å¦™è§‰å¾—å®ƒæ¯”è¾ƒçœç”µã€‚è¿™ä¸æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹æ˜¯åŒæ ·çš„ APIã€åŒæ ·çš„å¾‹åŠ¨å°ç®­å¤´ã€åŒæ ·çš„ä¸€ä¸ªè´´è¾¹å„¿æ¡å½¢ç ï¼Œåœ¨è¿™å° iPhone 12 ä¸Šï¼Œè¯†åˆ«å‡ºæ¥æ˜¯è¿™æ ·çš„ï¼Œå…·ä½“è¯†åˆ«å‡ºæ¥äº†å‡ ä¸ªï¼Œæˆ‘ä¹Ÿæ²¡æ•°ğŸ¤·â€â™€ï¸ï¼š

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_5.jpg 200%}</div>
</center>

...
...

<center>
	<div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg 80%}</div>
  <div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg 80%}</div>
  <div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg 80%}</div>
  <div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg 80%}</div>
  <div style="display:inline-block;">{%img https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg 80%}</div>
</center>




&#8195;&#8195;å“ªä¸ªåäººæ€»è¯´å®¢æˆ·ç«¯ç®€å•çš„ï¼Ÿæ‰“ä½ å“¦ã€‚

&#8195;&#8195;æ­£ç»äººè°åšå®¢æˆ·ç«¯å¼€å‘å•Šã€‚

&#8195;&#8195;å…³æœºï¼Œä¿å‘½ï¼Œå†è§ã€‚

## ä»£ç 

æœ€åä¸€å¥ï¼Œ[ä»£ç åœ¨è¿™é‡Œ](https://github.com/ATommyGirl/Vision.git)ï¼Œéœ€è¦è‡ªå–ã€‚

---
